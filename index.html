<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重庆新闻频道回放获取工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0B5ED7',
                        secondary: '#6C757D',
                        accent: '#FFC107',
                        dark: '#343A40',
                        light: '#F8F9FA'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .hover-scale {
                transition: transform 0.3s ease;
            }
            .hover-scale:hover {
                transform: scale(1.02);
            }
            .select-arrow {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            .program-live {
                background-color: rgba(11, 94, 215, 0.1);
                border-left: 3px solid #0B5ED7;
            }
            .toast-notification {
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: #333;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 50;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            .toast-notification.show {
                opacity: 1;
            }
            .btn-group {
                min-width: 215px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <header class="bg-primary text-white shadow-lg">
        <div class="container mx-auto px-4 py-6 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fa fa-play-circle-o text-3xl mr-3"></i>
                <h1 class="text-2xl md:text-3xl font-bold">重庆新闻频道回放获取工具</h1>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- 日期选择卡片 -->
        <div id="date-section" class="bg-white rounded-xl card-shadow p-6 mb-8 transition-all duration-300 hover:shadow-lg">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-calendar text-primary mr-2"></i>
                选择日期
            </h2>
            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                <div class="w-full sm:w-auto">
                    <div class="relative">
                        <select id="date-select" class="select-arrow block w-full rounded-md border-gray-300 shadow-sm py-2 pl-3 pr-8 focus:border-primary focus:ring focus:ring-primary/20 focus:outline-none sm:text-sm">
                            <!-- 选项将由JavaScript动态填充 -->
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <i class="fa fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0 self-end">
                    <button id="fetch-btn" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-6 rounded-md transition-all duration-300 shadow-md hover:shadow-lg flex items-center">
                        <i class="fa fa-search mr-2"></i>
                        获取节目列表
                    </button>
                </div>
                <div id="loading-indicator" class="hidden">
                    <i class="fa fa-circle-o-notch fa-spin text-primary"></i>
                </div>
            </div>
        </div>

        <!-- 提示信息 -->
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 rounded">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa fa-info-circle text-blue-500"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-blue-700">
                        使用github.io网站可能无法直接观看，可复制链接后手动粘贴到浏览器地址栏或者其他视频播放器观看。<br>距离当前日期最远的一天的节目回放可能会出现部分无法打开的情况，出现以上情况则说明对应内容已被重庆台删除。
                    </p>
                </div>
            </div>
        </div>

        <!-- 节目列表标题 -->
        <div id="program-title-section" class="flex flex-wrap items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-dark flex items-center">
                <i class="fa fa-list-ul text-primary mr-2"></i>
                <span id="program-date-title">5月26日</span> 节目列表
            </h2>
        </div>

        <!-- 节目列表 -->
        <div id="program-list" class="grid grid-cols-1 gap-4">
            <!-- 节目项将通过JavaScript动态生成 -->
            <div class="text-center py-16 text-gray-500">
                <i class="fa fa-film text-5xl mb-4 opacity-30"></i>
                <p class="text-lg">请选择日期并点击"获取节目列表"按钮</p>
            </div>
        </div>

        <!-- 节目总数统计 -->
        <div id="program-count-section" class="text-right text-sm text-gray-500 mt-4 mb-8">
            共 <span id="program-count">0</span> 个节目
        </div>

        <!-- 没有数据提示 -->
        <div id="no-data" class="hidden text-center py-16 text-gray-500">
            <i class="fa fa-exclamation-circle text-5xl mb-4 text-gray-400"></i>
            <p class="text-lg">没有找到该日期的节目数据</p>
        </div>

        <!-- 错误提示 -->
        <div id="error-message" class="hidden bg-red-50 border-l-4 border-red-400 p-4 mb-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa fa-exclamation-triangle text-red-500"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700" id="error-text">
                        无法获取节目数据，请稍后重试。
                    </p>
                </div>
            </div>
        </div>

        <!-- 视频播放区域 -->
        <div id="video-section" class="hidden">
            <h2 id="video-title" class="text-2xl font-bold text-dark mb-4 text-center">视频标题</h2>
            <video id="video-player" width="100%" controls>
                <source id="video-source" src="" type="video/mp4">
                您的浏览器不支持视频播放。
            </video>
            
            <div class="flex flex-wrap justify-center gap-4 mt-6">
                <button id="download-btn" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-6 rounded-md transition-all duration-300 shadow-md hover:shadow-lg flex items-center">
                    <i class="fa fa-download mr-2"></i> 下载
                </button>
                <button id="copy-link-btn" class="bg-secondary hover:bg-secondary/90 text-white font-medium py-2 px-6 rounded-md transition-all duration-300 shadow-md hover:shadow-lg flex items-center">
                    <i class="fa fa-link mr-2"></i> 复制链接
                </button>
                <button id="back-to-list-btn" class="bg-white text-primary font-medium py-2 px-6 rounded-md transition-all duration-300 shadow-md hover:shadow-lg">返回节目列表</button>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white py-4 mt-12">
        <div class="container mx-auto px-4 text-center text-gray-400 text-sm">
            © 2025 重庆广播电视集团（总台）第1眼TV & Larry18518 | 版权所有
        </div>
    </footer>

    <!-- 复制成功提示框 -->
    <div id="copy-toast" class="toast-notification">
        当前节目视频链接已复制到剪贴板。
    </div>

    <!-- 提示框 -->
    <div id="toast" class="toast-notification">当前节目视频链接已复制到剪贴板。</div>

    <script>
        // 工具函数
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateToChineseMonthDay(dateStr) {
            const [, month, day] = dateStr.split('-');
            return `${parseInt(month)}月${parseInt(day)}日`;
        }

        function formatDateToChineseFull(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${year}年${parseInt(month)}月${parseInt(day)}日`;
        }

        function formatTimeRange(startTime, endTime) {
            try {
                const startDate = new Date(startTime);
                const month = startDate.getMonth() + 1;
                const day = startDate.getDate();
                const startHours = String(startDate.getHours()).padStart(2, '0');
                const startMinutes = String(startDate.getMinutes()).padStart(2, '0');
                
                if (endTime) {
                    const endDate = new Date(endTime);
                    const endHours = String(endDate.getHours()).padStart(2, '0');
                    const endMinutes = String(endDate.getMinutes()).padStart(2, '0');
                    return `${month}月${day}日${startHours}:${startMinutes}-${endHours}:${endMinutes}`;
                } else {
                    return `${month}月${day}日${startHours}:${startMinutes}`;
                }
            } catch (error) {
                console.error('格式化时间范围出错:', error);
                return '未知时间';
            }
        }

        function isProgramLive(programStartTime, programEndTime) {
            try {
                const now = new Date();
                const startTime = new Date(programStartTime);
                const endTime = new Date(programEndTime);
                return now >= startTime && now < endTime;
            } catch (error) {
                console.error('判断节目是否直播出错:', error);
                return false;
            }
        }

        // 初始化日期选择器
        function initDateSelector() {
            const dateSelect = document.getElementById('date-select');
            const today = new Date();
            
            for (let i = 10; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i + 1);
                const dateStr = formatDate(date);
                const dateChinese = formatDateToChineseFull(dateStr);
                
                const option = document.createElement('option');
                option.value = dateStr;
                option.textContent = `${dateChinese} (${['周日', '周一', '周二', '周三', '周四', '周五', '周六'][date.getDay()]})`;
                
                if (i === 1) {
                    option.selected = true;
                }
                
                dateSelect.appendChild(option);
            }
            
            document.getElementById('program-date-title').textContent = formatDateToChineseMonthDay(dateSelect.value);
        }

        // 复制URL到剪贴板
        function copyUrlToClipboard(url) {
            navigator.clipboard.writeText(url)
                .then(() => {
                    const toast = document.getElementById('copy-toast');
                    toast.classList.add('show');
                    setTimeout(() => {
                        toast.classList.remove('show');
                    }, 3000);
                })
                .catch(err => {
                    console.error('复制失败:', err);
                });
        }

        // 获取节目列表
        async function fetchPrograms(date) {
            const programList = document.getElementById('program-list');
            const noData = document.getElementById('no-data');
            const errorMessage = document.getElementById('error-message');
            const programCount = document.getElementById('program-count');
            const fetchBtn = document.getElementById('fetch-btn');
            const loadingIndicator = document.getElementById('loading-indicator');
            
            programList.innerHTML = '';
            noData.classList.add('hidden');
            errorMessage.classList.add('hidden');
            fetchBtn.disabled = true;
            loadingIndicator.classList.remove('hidden');
            
            try {
                const maxRetries = 3;
                let retries = 0;
                
                while (retries < maxRetries) {
                    try {
                        const apiUrl = `https://cqxyinterface.cbgcloud.com/api/xy/toc/v1/queryTvRadioPrograms?appCode=FABU_YUNSHI&companyId=cqxwzx&userId=358598525698247cqxwzx&productId=6B1BEE01515143AFAF290F6044E54A89&serviceCode=YUNSHI_XSGL&date=${date}&rid=5ece08285c3a956d1c7f992a`;
                        const urlWithCacheBust = `${apiUrl}&_=${Date.now()}`;
                        
                        const response = await fetch(urlWithCacheBust);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP错误，状态码: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        document.getElementById('program-date-title').textContent = formatDateToChineseMonthDay(date);
                        
                        if (!data || !data.data || data.data.length === 0) {
                            noData.classList.remove('hidden');
                            programCount.textContent = '0';
                            return;
                        }
                        
                        programList.innerHTML = '';
                        data.data.forEach(program => {
                            addProgramItem(program);
                        });
                        
                        programCount.textContent = data.data.length;
                        return;
                        
                    } catch (error) {
                        console.error(`获取节目数据时出错 (尝试 ${retries + 1}/${maxRetries}):`, error);
                        retries++;
                        
                        if (retries < maxRetries) {
                            const delay = 1000 * retries;
                            console.log(`等待 ${delay/1000} 秒后重试...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
                
                throw new Error('所有重试都失败了');
                
            } catch (error) {
                errorMessage.classList.remove('hidden');
                document.getElementById('error-text').textContent = `获取节目数据失败: ${error.message}`;
            } finally {
                fetchBtn.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        // 添加节目项到列表
        function addProgramItem(program) {
            try {
                const programList = document.getElementById('program-list');
                
                let programName = program.programName || '';
                programName = programName.replace(/\[回看\]/g, '').trim();
                
                if (programName === 'program-over' || programName === 'checkpoint') {
                    programName = formatTimeRange(program.programStartTime, program.programEndTime);
                }
                
                const isLive = isProgramLive(program.programStartTime, program.programEndTime);
                const programItem = document.createElement('div');
                programItem.className = `bg-white rounded-lg card-shadow p-4 hover-scale ${isLive ? 'program-live' : ''}`;
                
                const programTime = formatTimeRange(program.programStartTime, program.programEndTime);
                
                programItem.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg text-dark">
                                <i class="fa fa-television text-primary mr-2"></i>
                                ${programName}
                            </h3>
                            <div class="text-sm text-gray-500 mt-1">
                                <i class="fa fa-clock-o mr-1"></i>
                                ${programTime}
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            ${program.backUrl ? 
                                `<button onclick="showVideo('${program.backUrl}', '${programName}', '${programTime}')" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-md transition-all duration-300 shadow hover:shadow-md flex items-center btn-group justify-center">
                                    <i class="fa fa-play-circle mr-2"></i> 收看
                                </button>` : 
                                `<span class="btn-group ${isLive ? 'bg-primary/10 text-primary' : 'bg-gray-200 text-gray-600'} font-medium py-2 px-4 rounded-md flex items-center justify-center">
                                    ${isLive ? 
                                        '<i class="fa fa-circle text-xs text-red-500 mr-2 animate-pulse"></i> 正在播出' : 
                                        '<i class="fa fa-clock-o mr-2"></i> 尚未播出'
                                    }
                                </span>`
                            }
                        </div>
                    </div>
                `;
                
                programList.appendChild(programItem);
            } catch (error) {
                console.error('添加节目项出错:', error);
            }
        }

        // 显示视频播放区域
        function showVideo(mediaUrl, programName, programTime) {
            const dateSection = document.getElementById('date-section');
            const programList = document.getElementById('program-list');
            const videoSection = document.getElementById('video-section');
            const videoSource = document.getElementById('video-source');
            const videoPlayer = document.getElementById('video-player');
            const videoTitle = document.getElementById('video-title');
            const programTitleSection = document.getElementById('program-title-section');
            const programCountSection = document.getElementById('program-count-section');

            // 隐藏不需要的元素
            dateSection.classList.add('hidden');
            programList.classList.add('hidden');
            programTitleSection.classList.add('hidden');
            programCountSection.classList.add('hidden');
            
            // 显示视频播放区域
            videoSection.classList.remove('hidden');

            if (mediaUrl) {
                videoSource.src = mediaUrl;
                videoPlayer.load();
                videoPlayer.play().catch(err => {
                    console.error("自动播放失败:", err);
                    // 这里可以添加用户交互提示，引导用户手动点击播放
                });
            }

            // 设置视频标题
            if (programName && programTime) {
                if (programName === programTime) {
                    videoTitle.textContent = programTime;
                } else {
                    videoTitle.textContent = `${programTime} ${programName}`;
                }
            }
        }

        // 返回节目列表
        function backToProgramList() {
            const dateSection = document.getElementById('date-section');
            const programList = document.getElementById('program-list');
            const videoSection = document.getElementById('video-section');
            const programTitleSection = document.getElementById('program-title-section');
            const programCountSection = document.getElementById('program-count-section');
            const videoPlayer = document.getElementById('video-player');

            // 停止视频播放并重置
            if (videoPlayer) {
                videoPlayer.pause();
                videoPlayer.currentTime = 0;
                videoPlayer.src = '';
            }

            // 显示节目列表相关元素
            dateSection.classList.remove('hidden');
            programList.classList.remove('hidden');
            programTitleSection.classList.remove('hidden');
            programCountSection.classList.remove('hidden');
            
            // 隐藏视频播放区域
            videoSection.classList.add('hidden');
        }

        // 下载按钮点击事件
        const downloadBtn = document.getElementById('download-btn');
        downloadBtn.addEventListener('click', () => {
            const videoSource = document.getElementById('video-source');
            const mediaUrl = videoSource.src;
            if (mediaUrl) {
                const link = document.createElement('a');
                link.href = mediaUrl;
                link.download = 'video.mp4';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        // 复制链接按钮点击事件
        const copyLinkBtn = document.getElementById('copy-link-btn');
        copyLinkBtn.addEventListener('click', () => {
            const videoSource = document.getElementById('video-source');
            const mediaUrl = videoSource.src;
            if (mediaUrl) {
                navigator.clipboard.writeText(mediaUrl)
                    .then(() => {
                        const toast = document.getElementById('toast');
                        toast.classList.add('show');
                        setTimeout(() => {
                            toast.classList.remove('show');
                        }, 3000);
                    })
                    .catch(err => {
                        console.error('复制失败: ', err);
                    });
            }
        });

        // 返回节目列表按钮点击事件
        const backToProgramListBtn = document.getElementById('back-to-list-btn');
        backToProgramListBtn.addEventListener('click', backToProgramList);

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            try {
                initDateSelector();
                
                document.getElementById('fetch-btn').addEventListener('click', () => {
                    const selectedDate = document.getElementById('date-select').value;
                    fetchPrograms(selectedDate);
                });
                
                fetchPrograms(document.getElementById('date-select').value);
            } catch (error) {
                console.error('页面初始化出错:', error);
                const errorMessage = document.getElementById('error-message');
                errorMessage.classList.remove('hidden');
                document.getElementById('error-text').textContent = `页面初始化失败: ${error.message}`;
            }
        });
    </script>
</body>
</html>
